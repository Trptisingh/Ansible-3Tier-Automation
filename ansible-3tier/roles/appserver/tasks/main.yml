---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install python3, pip, git, venv
  apt:
    name:
      - python3
      - python3-venv
      - python3-pip
      - git
    state: present

- name: Create application directory
  file:
    path: /opt/flaskapp
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Copy Flask app files
  copy:
    src: files/flask_app/
    dest: /opt/flaskapp/
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Create virtual environment
  command: python3 -m venv /opt/flaskapp/venv
  args:
    creates: /opt/flaskapp/venv/bin/activate

- name: Install Python dependencies
  pip:
    requirements: /opt/flaskapp/requirements.txt
    virtualenv: /opt/flaskapp/venv

- name: Deploy systemd service for Flask app
  template:
    src: flaskapp.service.j2
    dest: /etc/systemd/system/flaskapp.service
    mode: '0644'
  notify: restart flaskapp

- name: Reload systemd
  command: systemctl daemon-reload

- name: Enable and start Flask app service
  systemd:
    name: flaskapp
    enabled: yes
    state: started

